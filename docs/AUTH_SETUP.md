# Authentication System Setup Guide

This guide explains how to set up and use the authentication system implemented with Vercel storage.

## Architecture

The authentication system uses:
- **Vercel Postgres** for user data storage
- **Vercel KV** for session management
- **JWT** for secure token-based authentication
- **bcrypt** for password hashing
- **shadcn/ui** components for UI

## File Structure

```
src/
├── db/
│   └── client.ts                 # Database client and schema
├── lib/
│   └── auth.ts                   # Authentication utilities
├── app/
│   ├── api/auth/
│   │   ├── login/route.ts        # Login API endpoint
│   │   ├── register/route.ts     # Registration API endpoint
│   │   ├── logout/route.ts       # Logout API endpoint
│   │   └── me/route.ts          # Get current user endpoint
│   ├── login/
│   │   └── page.tsx              # Login/Register page
│   └── dashboard/
│       ├── page.tsx              # Protected dashboard
│       └── logout-button.tsx     # Logout button component
├── middleware.ts                 # Route protection middleware
```

## Setup Instructions

### 1. Install Vercel CLI (if not already installed)

```bash
npm install -g vercel
```

### 2. Link Your Project to Vercel

```bash
vercel link
```

### 3. Set Up Vercel Postgres

```bash
# Create a Postgres database in Vercel
vercel storage create postgres

# Pull environment variables to .env.local
vercel env pull .env.local
```

This will automatically populate your `.env.local` with:
- `POSTGRES_URL`
- `POSTGRES_PRISMA_URL`
- `POSTGRES_URL_NON_POOLING`
- `POSTGRES_USER`
- `POSTGRES_HOST`
- `POSTGRES_PASSWORD`
- `POSTGRES_DATABASE`

### 4. Set Up Vercel KV

```bash
# Create a KV database in Vercel
vercel storage create kv

# Pull environment variables again
vercel env pull .env.local
```

This will add:
- `KV_URL`
- `KV_REST_API_URL`
- `KV_REST_API_TOKEN`
- `KV_REST_API_READ_ONLY_TOKEN`

### 5. Generate JWT Secret

Add a secure JWT secret to your `.env.local`:

```bash
# Generate a random secret (macOS/Linux)
openssl rand -base64 32

# Or use Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

Add to `.env.local`:
```
JWT_SECRET=your-generated-secret-here
```

### 6. Initialize Database

The database table will be created automatically on first use, or you can manually initialize it:

```typescript
// In a server component or API route
import { initDatabase } from '@/db/client';

await initDatabase();
```

## Usage

### API Endpoints

#### Register User
```typescript
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securepassword123",
  "name": "John Doe"
}
```

#### Login
```typescript
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

#### Logout
```typescript
POST /api/auth/logout
```

#### Get Current User
```typescript
GET /api/auth/me
```

### Using in Server Components

```typescript
import { getSession, requireAuth } from '@/lib/auth';

// Optional authentication
export default async function Page() {
  const session = await getSession();

  if (!session) {
    return <div>Not logged in</div>;
  }

  return <div>Welcome {session.name}</div>;
}

// Required authentication
export default async function ProtectedPage() {
  const session = await requireAuth(); // Throws if not authenticated

  return <div>Welcome {session.name}</div>;
}
```

### Using in Client Components

```typescript
'use client';

import { useEffect, useState } from 'react';

export default function ClientComponent() {
  const [user, setUser] = useState(null);

  useEffect(() => {
    fetch('/api/auth/me')
      .then(res => res.json())
      .then(data => setUser(data.user))
      .catch(err => console.error(err));
  }, []);

  if (!user) return <div>Not logged in</div>;

  return <div>Welcome {user.name}</div>;
}
```

### Route Protection

The middleware automatically protects all routes except:
- `/login`
- `/api/auth/*`

Add additional public routes in `src/middleware.ts`:

```typescript
const publicRoutes = ['/login', '/api/auth/login', '/api/auth/register', '/public'];
```

## Environment Variables

Required environment variables in `.env.local`:

```bash
# Vercel Postgres (auto-generated by vercel storage create postgres)
POSTGRES_URL=
POSTGRES_PRISMA_URL=
POSTGRES_URL_NON_POOLING=
POSTGRES_USER=
POSTGRES_HOST=
POSTGRES_PASSWORD=
POSTGRES_DATABASE=

# Vercel KV (auto-generated by vercel storage create kv)
KV_URL=
KV_REST_API_URL=
KV_REST_API_TOKEN=
KV_REST_API_READ_ONLY_TOKEN=

# JWT Secret (generate manually)
JWT_SECRET=your-secure-random-string

# Node Environment
NODE_ENV=development
```

## Security Features

- Password hashing with bcrypt (10 salt rounds)
- HTTP-only cookies for token storage
- JWT with 7-day expiration
- Secure cookies in production (HTTPS only)
- SameSite cookie protection
- Route-level authentication middleware
- Input validation with Zod

## Testing Locally

1. Start the development server:
```bash
npm run dev
```

2. Navigate to `http://localhost:3000/login`

3. Create a new account or login with existing credentials

4. You'll be redirected to `/dashboard` upon successful authentication

5. Try accessing `/dashboard` without logging in - you'll be redirected to `/login`

## Deployment to Vercel

```bash
# Deploy to production
vercel --prod

# Set environment variables in production
vercel env add JWT_SECRET production
```

The Postgres and KV environment variables are automatically configured when you create the storage resources.

## Troubleshooting

### Database Connection Errors

If you see database connection errors:
1. Verify `.env.local` has all Postgres variables
2. Run `vercel env pull .env.local` to refresh variables
3. Restart the development server

### Session Not Persisting

If sessions aren't persisting:
1. Check that cookies are enabled in your browser
2. Verify `JWT_SECRET` is set in `.env.local`
3. Clear browser cookies and try again

### KV Connection Issues

If KV connection fails:
1. Verify KV environment variables are set
2. Check KV dashboard in Vercel for connection status
3. Ensure you're using the correct region

## Next Steps

- Add email verification
- Implement password reset
- Add OAuth providers
- Enhance session management
- Add role-based access control
- Implement refresh tokens

## Support

For issues or questions:
- Check the Vercel Postgres docs: https://vercel.com/docs/storage/vercel-postgres
- Check the Vercel KV docs: https://vercel.com/docs/storage/vercel-kv
- Review the Next.js authentication patterns: https://nextjs.org/docs/app/building-your-application/authentication
